name: SonarQube Scan (Python)

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  sonar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r backend/requirements.txt
          python -m pip install bandit

      - name: Run tests (optional)
        working-directory: backend
        run: |
          python -m pytest --maxfail=1 --disable-warnings -q || true
      
      - name: Run Bandit Security Scan
        working-directory: backend
        run: |
          echo "üîç Running Bandit security scan..."
          bandit -r app/ -f json -o bandit-report.json || echo "‚ö†Ô∏è Bandit finished with issues, but not blocking build."

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: backend/bandit-report.json
      
      - name: Send Bandit JSON report to Discord
        if: always()
        run: |
           curl -F "payload_json={\"content\": \"üõ°Ô∏è Rapport Bandit (analyse de s√©curit√© Python)\"}" \
           -F "file=@backend/bandit-report.json" \
           ${{ secrets.DISCORD_WEBHOOK_URL }}


      # ==== FRONTEND (React) ===


      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint frontend
        working-directory: frontend
        run: npm run lint || echo "‚ö†Ô∏è Lint warnings, but continuing"

      - name: Run frontend tests
        working-directory: frontend
        run: npm test -- --watchAll=false || echo "‚ö†Ô∏è Tests failed, continuing build"

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build

  
      # ==== SONARQUBE SCAN ====


      - name: Run SonarQube Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=drownedmilan
            -Dsonar.projectKey=DrownedMilan_time_manager
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.sources=backend/app,frontend/src
            -Dsonar.exclusions=**/node_modules/**,**/build/**

      - name: Send Discord Notification             # DISCORD NOTIF
        if: always()  # s‚Äôex√©cute m√™me si le build √©choue
        run: |
          STATUS="‚úÖ Build succeeded"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="‚ùå Build failed"
          fi
          BRANCH="${GITHUB_REF_NAME}"
          MESSAGE="üöÄ New push on branch **$BRANCH** by **${{ github.actor }}**\nStatus: $STATUS\nüîó [View run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"$MESSAGE\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}


  # ==== TRIVY SCAN FIXED ===

  trivy-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        run: docker build -t time_manager-backend ./backend

      - name: Build frontend image
        run: docker build -t time_manager-frontend ./frontend

      # ---- Scans individuels (fix parsing error) ----

      - name: Run Trivy scan (backend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: time_manager-backend
          format: 'json'
          output: 'trivy-backend.json'

      - name: Run Trivy scan (frontend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: time_manager-frontend
          format: 'json'
          output: 'trivy-frontend.json'

      - name: Run Trivy scan (postgres)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: postgres:17-bookworm
          format: 'json'
          output: 'trivy-postgres.json'

      - name: Run Trivy scan (nginx)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: nginx:1.28.0-alpine3.21
          format: 'json'
          output: 'trivy-nginx.json'

      - name: Run Trivy scan (keycloak)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: quay.io/keycloak/keycloak:26.4.0
          format: 'json'
          output: 'trivy-keycloak.json'

      # ---- Upload et notification ----

      - name: Upload all Trivy reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-docker-reports
          path: |
            trivy-backend.json
            trivy-frontend.json
            trivy-postgres.json
            trivy-nginx.json
            trivy-keycloak.json

      - name: Send report to Discord
        if: always()
        run: |
          zip trivy-reports.zip trivy-*.json
          curl -F "payload_json={\"content\": \"üß© Rapports Trivy (analyse Docker multi-images)\"}" \
               -F "file=@trivy-reports.zip" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
