# /etc/nginx/nginx.conf

events {}

http {
  # Pour WebSocket (Vite HMR, SSE, etc.)
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # Logs (facultatif : ajuste le niveau si besoin)
  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log warn;

  # Taille uploads (augmente si besoin)
  client_max_body_size 10m;

  server {
    listen 80;
    server_name localhost;

    # ---------- Healthcheck simple ----------
    location = /nginx-health {
      return 200 "ok";
      add_header Content-Type text/plain;
    }

    # ---------- FRONTEND (Vite dev server) ----------
    # location / {
    #   proxy_pass http://frontend:3000;

    #   proxy_http_version 1.1;
    #   proxy_set_header Upgrade             $http_upgrade;
    #   proxy_set_header Connection          $connection_upgrade;

    #   proxy_set_header Host                $http_host;
    #   proxy_set_header X-Real-IP           $remote_addr;
    #   proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
    #   proxy_set_header X-Forwarded-Proto   $scheme;
    #   proxy_set_header X-Forwarded-Host    $http_host;
    #   proxy_set_header X-Forwarded-Port    $server_port;

    #   proxy_read_timeout 300s;
    #   proxy_send_timeout 300s;
    #   proxy_redirect off;
    # }

    # ---------- BACKEND API ----------
    location /api/ {
      proxy_pass http://backend:80/;

      proxy_http_version 1.1;
      proxy_set_header Upgrade             $http_upgrade;
      proxy_set_header Connection          $connection_upgrade;

      proxy_set_header Host                $http_host;
      proxy_set_header X-Real-IP           $remote_addr;
      proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto   $scheme;
      proxy_set_header X-Forwarded-Host    $http_host;
      proxy_set_header X-Forwarded-Port    $server_port;

      proxy_redirect off;
    }

    # ---------- KEYCLOAK (sous /auth/) ----------
    location /auth/ {
      proxy_pass http://keycloak:8080/auth/;

      proxy_http_version 1.1;
      proxy_set_header Upgrade             $http_upgrade;
      proxy_set_header Connection          $connection_upgrade;

      proxy_set_header Host                $http_host;
      proxy_set_header X-Real-IP           $remote_addr;
      proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto   http;
      proxy_set_header X-Forwarded-Host    $http_host;
      proxy_set_header X-Forwarded-Port    $server_port;

      proxy_buffering off;
      proxy_request_buffering off;
      proxy_redirect off;
    }

    # ---------- FIX POUR SWAGGER ----------
    location = /openapi.json {
      proxy_pass http://backend:80/openapi.json;
    }
  }
}
